# mysql

## 存储引擎

InnoDB和myISAM区别

后者在mysql5.5更新为前者

行锁、mvcc

外键

事务

b+tree存储，索引文件和数据文件是一体的，后者分离

前者基于redo日志，数据崩溃恢复

## 索引

### 介绍

存储用于快速查找的数据结构。

### 分类

##### 数据结构

###### B+Tree索引

 都支持

###### hash索引 

Memory支持

###### full-text索引

InnoDB 和 myISAM

###### 



##### 物理存储

###### 聚簇索引

又叫主键索引，b+tree叶子节点存数据

###### 二级索引

b+tree叶子节点存主键

二级索引查主键或索引 又叫 覆盖索引

其余情况都会回表

###### b+树

树高为三到四，叶子存数据，非叶子存索引，数据之间双向链表连接

###### b树

都存数据

###### 二叉树

树会非常高

###### hash

O(1)等值查询

##### 字段特性

主键索引：有主键，且唯一非空

唯一索引：可以有多个，唯一可空

普通索引：非主键 非唯一

前缀索引：字符型字段前缀

##### 字段个数

###### 单列索引

###### 联合索引

最左前缀法则

(a, b, c）为联合索引

细节：以a字段排序相对b相对c有序，整体b、c无序

where a > 3 and b = 1 b不走

where a >= 3 and b = 1 都走聚合索引

a = 1 c =2 也走

mysql 5.6后 c = 2 a = 1 也走  

是等于的时候走索引，能走而不是全走索引

### 优缺点

优点：查找效率提高

缺点：增加存储负担，创建耗时，动态维护耗时

### 什么时候需要索引

是否唯一（重复）

where查询 排序条件oderby groupby

数据多少、是否动态变化

### 优化

####  主键索引自增

储存连续，防止页分裂

#### 唯一索引非空

计算变复杂，null占用空间无意义

#### 覆盖索引

尽量不要回表，为查询添加联合索引等。

#### 前缀索引

本身就是选用字符型前缀，减少空间占用

#### 避免索引失效

未遵守最左前缀

like %x（x%是可以的）

索引列上进行计算、函数、类型转化

字句有or有一列字段没有索引

### 事务

#### 特性

ACID

A原子性 事务全部成功和失败

C一致性 操作前后，数据完整一致

I隔离性 并发下，互不影响

D持久性 永久修改

#### 问题

脏读，

不可重读，

幻读

##### 幻读！

###### 是什么

同一查询在不同时间查出不同结果

###### RC和RR

读已提交和可重复读

前者：每次sql创建多个数据快照

后者：第一次sql创建一份数据快照，解决幻读

###### 快照读解决幻读

MVCC机制，RR级别下第一次sql创建数据快照，用这份数据快照查询undo log版本链的版本数据

###### 当前读解决幻读

通过next-key lock，范围和整条记录加锁，防止插入间隙

###### 完全解决幻读

不同事务有插入不加update只有mvcc，会发生幻读

第一次查询加select...for update，彻底解决幻读

#### 隔离级别 

读未提交、读已提交、可重复读、串行化

### 锁

#### 全局锁

##### 场景

备份数据库

##### 缺点

比如备份时上锁，其他事务都在等待。

##### 解决

InnoDB引擎下已经是可重复读的隔离级别，走MVCC机制



#### 共享锁和排他锁

读锁和写锁，表锁和行锁都存在

#### 表级锁

##### 表锁

普通表级锁

##### 元数据锁

只是用来区别表结构

###### 组成

CURD 读锁

改变表结构 写锁

###### 使用

不被显示调用，生命周期为事务

###### 问题

线程申请不到写锁，导致sql阻塞？

申请锁的操作队列中，写锁优先级大于读锁。

##### 意向锁

###### 场景

在InnoDB引擎给某些字段加行级共享锁时，先加意向共享锁。

###### 作用

用于判断表记录中是否有锁。

###### 与共享锁排他锁

意向锁之间兼容。

意向锁和表级共享锁、排他锁读读共享。

意向锁和行级共享锁、排他锁不影响

##### AUTO-INC锁

自增时上锁，生命周期为插入结束

#### 行级锁

##### 记录锁

对一条记录加锁。读读共享

##### 间隙锁

对行记录范围加锁。兼容

##### 邻键锁

记录锁+间隙锁的组合，锁范围和本身。读读共享。

##### 插入意向锁

判断有没有间隙锁或邻键锁，有则加入这个特殊的行锁，其中锁释放后释放

##### MVCC

多版本并发控制

###### 功能

并发事务下在每个数据行维护了版本控制数据，保证事务的一致性和隔离性。

###### 组成

读操作：选中数据行，选中事务开始的版本，读取数据快照

写操作：修改数据行，创建新的版本控制数据，保留之前的

事务提交和回滚：修改数据最新版本，其他事务可见。回滚时其他事务不可见

版本回收 定期回收旧版本数据

###### 实现

隐藏字段 3个

readView数据快照 开始事务之前创建的，保存对本事务不可见的其他活跃事务

undo日志 事务回滚和mvcc的非锁定读

###### 非锁定读

只是加上一个版本号或者时间戳，读取行数据的数据快照。

解决了不可重复读和部分幻读问题。

锁定读：事务下，读取记录使用next-key Lock，防止其他事务在间隙插入数据

###### 数据快照

创建数据快照

快照读取（readView）：是开始事务之前的创建，对本事务不可见的其他活跃事务

#### 锁的使用

##### sql上锁

select 非锁定读 -> 快照读

select...lock in share mode共享锁

select ... for update独占锁

insert、update、delete独占锁

##### 行锁使用

###### 基本

针对索引对象，基本单位为next-key lock。

邻键锁 前开后闭

间隙锁 前开后开

###### 唯一索引等值

存在：退化记录锁

不存在：退化间隙锁

###### 唯一索引范围

大于：大于等于：存在时边界退化记录锁，其余不退化。

小于：小于等于：存在不退化，其余终止范围退化间隙锁。

：上述都是主键索引测试的结果

###### 非唯一索引等值

不存在：查到的二级索引加next-key，第一不符合退化间隙锁，主键索引不加锁

存在：同上，主键加记录锁

###### 非唯一索引范围

不退化，二级索引加next-key，主键索引加记录锁

###### 无索引

每行加next-key，锁全表

## 日志

### redo重做日志

存数据页，和buffer pool交互，用于掉电恢复

#### buffer pool

从磁盘更新缓存数据，更新重做日志缓存，清空前者刷盘到redo log

### bin归档日志

记录表结构和数据修改的数据，用于备份恢复、主从复制

### undo回滚日志

记录sql，用于事务回滚

### 其他日志

错误日志、查询日志、慢查询日志

