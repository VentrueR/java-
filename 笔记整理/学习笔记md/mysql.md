# mysql

## sql优化

1. 避免select*
2. 避免子查询
3. 避免union，多的时候去重很费时间（除非特定需要）
4. limit加id来查
5. 小表驱动大表
6. 索引优化（索引设计合理，能够走索引，避免回表等等）

## 存储引擎

InnoDB/myISAM/Memory

isam在mysql5.5更新为前者，变量记录了行数，count会更快



行锁、mvcc

外键约束

事务

前者基于redo日志，数据崩溃恢复



聚簇索引~

//b+tree存储，索引文件和数据文件是一体的，后者分离





Memory存储在内存，重启丢失

## 索引

### 介绍

存储用于快速查找的数据结构。

### 分类

##### 数据结构

###### B+Tree索引

 都支持

###### hash索引 

Memory支持

###### full-text索引

InnoDB 和 myISAM

###### 



##### 物理存储

###### 聚簇索引

索引和数据不分开（反之非聚簇就是分开的，叶子存指向数据的指针或者主键）



b+tree叶子节点存数据

###### 二级索引

二级索引查主键或索引 又叫 覆盖索引

其余情况都会回表



b+tree叶子节点存主键

###### b+树

树高为三到四，叶子存数据，非叶子存索引，数据之间双向链表连接

###### b树

都存数据

###### 二叉树

树会非常高

###### hash

O(1)等值查询

##### 字段特性

主键索引：有主键，且唯一非空

唯一索引：可以有多个，唯一可空

普通索引：非主键 非唯一

前缀索引：字符型字段前缀

##### 字段个数

###### 单列索引

###### 联合索引

最左前缀法则

(a, b, c）为联合索引

细节：以a字段排序相对b相对c有序，整体b、c无序

where a > 3 and b = 1 b不走

where a >= 3 and b = 1 都走聚合索引

a = 1 c =2 也走

mysql 5.6后 c = 2 a = 1 也走  

是等于的时候走索引，能走而不是全走索引



### 索引下推

新增的优化性能，提前判Where减少回表次数

### 优缺点

优点：查找效率提高

缺点：增加存储负担，创建耗时，动态维护耗时

### 什么时候需要索引

好：唯一、where、排序

不好：上述没用到、重复、经常更新、数据少

### 索引优化

####  主键索引自增

储存连续，防止页分裂

#### 唯一索引非空

计算变复杂，null占用空间无意义

#### 覆盖索引

尽量不要回表，为查询添加联合索引等。

#### 前缀索引

本身就是选用字符型前缀，减少空间占用

#### 避免索引失效

未遵守最左前缀

like %x（x%是可以的）

索引列上进行计算、表达式、函数、类型转化

字句有or有一列字段没有索引

### 事务

#### 特性

ACID

A原子性 事务全部成功和失败

C一致性 操作前后，总数据完整一致的（没有多或少）

I隔离性 并发下，互不影响

D持久性 永久修改

#### 问题

##### 脏读

A事务读，B事务改不提交，A事务读不对

##### 不可重读

A事务读，B事务提交，A再读就不对

##### 幻读

###### 是什么

同一查询在不同时间查出不同结果

举例： A事务查询，B事务插入，A再查询出现

###### RC和RR

读已提交和可重复读

前者：每次sql创建多个数据快照

后者：事务，第一次sql创建一份数据快照，解决部分幻读

###### 快照读和当前读

普通select

**其他sql语句和select ...for update（读最新）**

###### 没解决的幻读

A事务读，B事务插入提交，A事务更新再读

~~select ... for update当前读

这让他们读最新

###### 快照读解决部分幻读

MVCC机制，RR级别下第一次sql创建数据快照，用这份数据快照查询undo log版本链的版本数据

###### 当前读解决幻读

事务开始后立马加**select ... for update**，

通过next-key lock，范围和整条记录加锁，防止插入间隙

###### 完全解决幻读

不同事务有插入不加update只有mvcc，会发生幻读

第一次查询加select...for update，彻底解决幻读

#### 隔离级别 

读未提交、读已提交、可重复读、串行化（加行锁）

### 锁

#### 全局锁

##### 场景

备份数据库

##### 缺点

比如备份时上锁，其他事务都在等待。

##### 解决

InnoDB引擎下已经是可重复读的隔离级别，走MVCC机制



#### 共享锁和排他锁

读锁和写锁，表锁和行锁都存在

#### 表级锁

##### 表锁

普通表级锁

##### 元数据锁

只是用来区别表结构

###### 组成

CURD 读锁

改变表结构 写锁

###### 使用

不被显示调用，生命周期为事务

###### 问题

线程申请不到写锁，导致查询sql阻塞？

申请锁的操作队列中，写锁优先级大于读锁。

##### 意向锁

###### 场景

加行锁前加的意向表锁（和共享/独占表锁互斥）



在InnoDB引擎给某些字段加行级共享锁时，先加意向共享锁。

###### 作用

用于快速判断表记录中是否有锁。

###### 与共享锁排他锁

意向锁之间兼容。

//意向锁和表级共享锁、排他锁读读共享。

//意向锁和行级共享锁、排他锁不影响

##### AUTO-INC锁

自增时上锁，生命周期为插入结束

#### 行级锁

##### 记录锁

对单条记录加锁。读读共享

##### 间隙锁

数据间隙加锁。兼容

##### 邻键锁

记录锁+间隙锁的组合，锁范围和本身。读读共享。左开右闭

##### 插入意向锁

特殊间隙锁，告诉这个间隙被加锁了



判断有没有间隙锁或邻键锁，有则加入这个特殊的行锁，其中锁释放后释放

##### MVCC

多版本并发控制

###### 功能

4个核心字段：创建的事务id/活跃未提交的事务id列表/最小活跃事务Id/下一个创建事务的id

2个隐藏字段：对聚簇索引操作，事务id记录在隐藏列/对聚簇索引操作写undo日志

已提交事务id，活跃事务Id(使用未提交)，未开始事务id

并发事务下在每个数据行维护了版本控制数据，保证事务的一致性和隔离性。

###### 组成

读操作：选中数据行，选中事务开始的版本，读取数据快照

写操作：修改数据行，改动记录在隐藏列，配合undo日志修改

事务提交和回滚：修改数据最新版本，其他事务可见。回滚时其他事务不可见

版本回收 定期回收旧版本数据

###### 实现

隐藏字段 3个

readView数据快照 开始事务之前创建的，保存对本事务不可见的其他活跃事务

undo日志 事务回滚和mvcc的非锁定读

###### 非锁定读（快照读）

只是加上一个版本号或者时间戳，读取行数据的数据快照。

解决了不可重复读和部分幻读问题。

锁定读：事务下，读取记录使用next-key Lock，防止其他事务在间隙插入数据

###### 数据快照

创建数据快照

快照读取（readView）：是开始事务之前的创建，对本事务不可见的其他活跃事务

#### 锁的使用

##### sql上锁

select 非锁定读 -> 快照读

select...lock in share mode共享锁

select ... for update独占锁

insert、update、delete独占锁

##### 行锁使用

###### 基本

针对索引对象，基本单位为next-key lock。

邻键锁 前开后闭

间隙锁 前开后开

###### 唯一索引等值

存在：退化记录锁

不存在：退化间隙锁

###### 唯一索引范围

大于：大于等于：存在时边界退化记录锁，其余不退化。

小于：小于等于：存在不退化，其余终止范围退化间隙锁。

：上述都是主键索引测试的结果

###### 非唯一索引等值

不存在：查到的二级索引加next-key，第一不符合退化间隙锁，主键索引不加锁

存在：同上，主键加记录锁

###### 非唯一索引范围

不退化，二级索引加next-key，主键索引加记录锁

###### 无索引

每行加next-key，锁全表

## 日志

### redo重做日志

概述:

存数据页，和buffer pool交互，用于掉电恢复

过程:

开启事务，buffer pool存磁盘数据页，sql处理后写redo日志，wal技术合适时间，顺序写回磁盘(脏页刷盘)。



区别undo在于，事务提交后崩溃，通过redo恢复

#### buffer pool

提升交互效率

从磁盘更新缓存数据，更新重做日志缓存，清空前者刷盘到redo log

### bin归档日志

记录表结构和数据修改的数据，用于备份恢复、主从复制



每次~，写binlog记录到binlog文件.

分为 statement(sql)/row(记录)/mixed（根据不同情况使用上述的哪个格式）

### undo回滚日志

事务开始，记录回滚日志，事务异常或者提交失败，走回滚



记录sql，用于事务回滚和MVCC

### 其他日志	

中继日志（主从复制）、错误日志、查询日志、慢查询日志、

## 架构

### 主从复制

写入：主库写binlog，提交事务，更新数据

同步：从库接收binlog，写relayLog，响应主库接收成功

回放：读relayLog，更新从库数据



实现了写主库，读从库

### 主从延迟

直接在主库上执行

### 分库分表

分库：连接多，单机库负载压力大

分表：表数据多，影响查询效率

垂直分库：模块功能分

垂直分表：大表拆小表，核心表拆出来

水平分库、分表：同样的库，同样的表结构



## SQL

### 范式

#### 函数依赖

(A,B) -> C

部分函数依赖：A和B分别能决定C

完全函数依赖：AB一起才能决定C

#### 第二范式

消除非主属性对（候选键）码的部分函数依赖

//策略表、奖品表、策略奖品表

员工/部门

#### 第三范式

消除...传递函数依赖

（学号）学生/班主任/班主任性别（已经第二范式）

//策略表和策略规则表

### JOIN

full join 根据关系匹配，保留表的空字段，一般用union

cross join 纯粹笛卡尔积
