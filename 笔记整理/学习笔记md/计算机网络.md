# 计算机网络

## 输入一个url的全过程

输入url



解析：协议/主机号（域名/主机地址），不合法走搜索引擎，非法字符做转义



浏览器缓存（localstroage）



域名解析dns，根/顶层/权威，解析目标ip地址



目标mac，ip和本机子网掩码与运算，查看是否是同一个子网，是的话直接APR协议拿到mac，否则网关（默认路由器）转发,ARP协议网关地址作为目标主机Mac地址



本机ip/mac已知，tcp连接，发报文，链路层封帧（源mac和目标mac），（物理层）有线无线传输，接收方拆帧，往上层传，路由器根据路由表转发，找网络地址最长匹配，最终拿到主机地址，接收报文

三次握手



https 还有ssl的四次握手



https请求服务端资源，服务端响应，前端控制器渲染

## OSI七层模型

### 应用

为计算机用户提供服务

### 表示

转化为本系统能识别的数据格式（解压缩，编解码，加解密）

### 会话

建立、管理、终止应用程序之间数据的通信会话

### 传输

负责应用层实体通信传输（关联应用层）

### 网络

数据的路由、转发、分页。（真通信传输）

### 数据链路

数据封帧、差错检测、MAC寻址

MAC地址标识硬件

### 物理

物理设备上原始比特流传输数据

## IP地址

### 基本认识

#### 简介

属于网络层，标识了互联网或本地网络设备。

#### 作用

实现不同主机之间通信、数据传输

#### 与MAC关系

通信有无直接连接

### 基础知识

#### 分类地址

##### 组成

主机号、网络号

##### 划分

网络地址、主机地址、广播地址

##### 分类

###### A、B、C类

0 128 192 按网络号分类（点分十进制）

0 10 110  二进制

24 16 8    主机号位数

最大主机个数: 2^n-2

广播地址：本地广播、直接广播

###### D、E类

D类 多播地址 1110

预留 224.0.0.0~

可用 224.0.1.0~

本地 239.0.0.0~

E类未开

##### 优缺点

优点：好判断分类 1110 看第X位

缺点：开发、上线、测试等ip分层不直观。C、B可用主机和现实需求有违背

#### 无分类地址

##### 怎么划分

192.168.0.1/24

##### 为什么划分

路由器寻址直接识别网络号

##### 子网地址

一般来说子网掩码最后八位有变化 生成子网地址 和 子网主机地址

#### 共有IP和私有IP

##### 组成数字 

A 10

B 172

C 192

##### 机构

#### 路由控制

##### 作用

网络地址用于路由控制

##### 流程

发送IP包，确认包首部目标地址，根据路由控制表，进行最长匹配，再转发

##### 环回地址

网络通信默认地址127.0.0.1。数据包不流向网络。

#### 分片与重组

超过MTU最大传输单元 1500字节

IP分片 -> 路由控制转发 -> 目标主机重组

## HTTP

### 是什么

超文本传输协议，协议包含传输包含文本。

html就是一种超文本，是文字、图片、视频、超链接的集合体。

### 常见状态码

#### 1xx 

提示信息。协议处理中间状态。

#### 2xx

成功。

200 且响应头有Body

204 响应头没有Body

206 响应头Body不全，出现在分块下载或断电传续

#### 3XX

 重定向。

301永久，请求资源不存在，修改重定向url

302 临时，请求资源存在，也需修改url

304 未修改，资源未修改，重定向缓存文件

#### 4XX

客户端错误。

400 客户端请求报文错误，笼统错误

403 服务器禁止访问资源。

404 服务端找不到资源

#### 5XX

服务器错误。

500 服务器笼统错误

501 服务器不支持客户端请求的功能

502 服务器作为网关或代理，本身正常，后端服务器有问题

503 服务器繁忙，重试。

### 常见字段

host

用于指定服务器域名

connection

长连接 设置http首部字段为Keep-Alive

content-length

响应数据长度

#### 沾包问题

1. 换行符、回车符作为head边界

2. content-length作为body边界

content-type

返回文本类型和编码类型

content-encode

返回压缩类型

### GET和POST

get请求 获取服务器资源，安全、幂等、可缓存

post请求 根据请求报文处理服务器资源，不安全、不幂等、一般不可缓存

安全：资源不被破坏（修改）

幂等：多次相同操作后，结果不变（新增）

GET请求可以带body但用不上。

### HTTP缓存

#### 强制缓存 

判断缓存未过期，直接走本地缓存

#### 协商缓存

客户端与服务器协商后，再是否走缓存

### HTTP1.1特性

#### 优点

简单 基本报文格式head和body 头部信息为key-value格式

易拓展 组成可以自定义如状态码，url

应用广泛跨平台

#### 缺点

无状态 不记录状态信息。虽然少占用了服务器资源，但关联操作上不便。

引入cookie和session

明文传输 是暴露出来的

不安全 明文传输和恶意攻击

#### 性能

长连接

管道网络运输：解决请求的队头阻塞

### http和https

#### 区别

后者加入了安全协议SSL/TLS

TCP连接三次握手后，安全协议也要握手

端口号80 443

#### 问题和解决

窃听风险 混合加密

篡改风险 摘要算法和签名 前者哈希算法，后者用非对称加密算法，私钥加密公钥解密，对内容哈希值加密，确认消息身份

冒充风险 数字证书

### http1.1、http/2、http/3

#### 1.1

在前者特性中提过。

#### 2.0(https)

头部压缩 把多个请求相同head,消除重复部分

二进制格式 转换为头信息帧和数据帧

并发运输 引入stream，不同请求对应唯一streamId，响应时按StreamId有序组成消息，所以可以并发请求和响应。

tcp层还是存在队头阻塞，tcp协议需要数据完整连续，不连续数据可能存内核缓存中，全部到达应用层才能拿到数据。

服务器推送资源 可以主动向客户端发消息

#### 3.0 

基于udp的QUIC协议

无队头阻塞 某个流丢包，只阻塞本流，不影响其他流

更快建立连接 quic协议握手

连接迁移 基于连接ID而不是四元组

## TCP

### 头格式

#### 序列号 

解决包乱序

#### 确认应答号 

解决丢包

#### 控制位 

syn 建立连接位

ack 确认连接位

fin 断开连接位

rst 异常断开连接位

### 什么是TCP

可靠、面向连接、字节流的传输层协议

保证- 》数据完整、连续。

一对一连接。流式传输，响应报文有序。

### 为什么需要

TCP协议确保了数据完整、非冗余、连续、有序

### TCP连接

socket、序列号、窗口大小保证可靠、流量控制的连接

IP地址和端口号。解决乱序。流量控制。

### 如何确定唯一TCP连接

源地址、源端口号、目标地址、目标端口号

### TCP最大连接

IP地址*端口号

2^32 * 2^16

受文件限制符 和 内存影响

### TCP和UDP区别、应用场景

#### 区别

TCP是什么 -> 4个点

可靠（数据完整）、面向连接（有无连接、一对？）、字节流（有无流式）。

首部（前者有可选选项）、窗口大小（有无流量控制）、分片（MSS TCP层丢失分片 只传丢失的分片\MTU IP层分片再组装）

#### 场景

前者ftp\http\https

后者dns、音视频、广播

#### 可使用同一端口

主机收到数据，先解析头部判断那种传输协议，再送至相应协议模块处理

### 三次握手

#### 过程

1. 客户端初始化syn报文序列号 syn置1 发送syn报文（发送状态）服务端接收（监听状态）
2. 服务端初始化syn+ack报文序列号,确认应答号 syn\ack置1（报文序列号+1）发送syn+ack报文（发送状态）
3. 客户端（连接状态） syn置1 发送ack报文确认应答号=syn+ack序列号+1

#### 为什么三次握手

历史连接问题 -》 初始化序列号 --》 避免资源浪费

二次 -》 四次

#### 为什么不是两次

防止历史连接 -> 同步初始化序列号、减少资源开销

####  为什么序列号不同

防止四元组重复连接

安全问题，接收伪造报文

#### 握手丢失 

超时重传，上次重传时间的两倍。最大重传次数。

第一次握手丢失 重传syn

第二次握手丢失 重传syn和 syn+ack

第三次握手丢失 重传第二次syn+ack 和 ack

#### accept

第一次握手服务端收到syn后，拿到内核半连接队列，

三次握手后，移除半连接队列，拿到内核的全连接队列，accept取连接给用户使用

#### syn攻击

伪造syn攻击服务器，服务器无法响应

大量syn攻击，导致半连接队列溢出，拿不到最新报文，连接失败。

解决：增大半连接队列/syncookie/减少二次握手重试

### 四次挥手

客 -》 服

->fin

ack <- 预备read() eof

fin <- read() eof不再接收数据	

客户端超时等待状态（2msl）

-> ack

客户端超时等待状态（2msl）



#### 中间两次变一次？

ack报文发的时候，还在处理（发送）数据，再发fin

如果没有处理数据并且开启ack延迟机制，可以合并三次挥手



#### 一直在第三次挥手？

shutdown()函数关闭，等待数据处理完

close()，没收到fin，默认60s关闭



#### 第二次和第三次中主动断开

shutdown()，只断开发送，还是可以接收



#### 第一次fin报文丢失

客户端close()的情况，默认超时60s后客户端关闭，但服务端还是连接



#### 第四次挥手等2msl？

msl报文最大生存时间（linux默认30s），ip路由次数一般64，每次路由-1，为0丢失数据报，给源主机发送报文通知，（默认ip路由结束时报文刚好消失），2msl刚好是请求响应报文一来一回，**允许客户端ack报文丢失一次**。



#### 服务端大量timewait

服务端主动断开连接 -》 请求超时（timewait）

原因：没使用长连接（Connection:close）/长连接超时/长链接请求超阈值

## 应用层

### 应用层协议有哪些

### 报文部分

行/头/空行/体、

### 常用状态码

1 协议处理中间状态

2 成功 200

3 重定向（资源位置发生变动，需要新url） 301/302(永久/临时)

4 客户端错误 404/405（请求方法不支持）

5 服务端错误

#### 301/302

Location字段指定 url

#### 502/504

网关或者代理工作服务器工作，响应无效/超时效应

### 请求类型有哪些

get/post/put/delete/head(只返回资源头部信息)

#### get/post

获得信息，安全幂等，缓存，书签

根据body更改信息，不...

### http的长连接

短连接，反复建立释放连接，影响请求速度

头部的keep-alive字段来指定

任意一端可以去断开

### 默认端口

http80/https443

###  http1.1怎么拆包

通过头content-length字段声明请求正文字节数，响应取对应字节，保证服务器接收

### http为什么不安全

行为 -》 拿到（窃取）/恶意植入（篡改）/消费（冒充）-》加密/校验/身份认证 

### http/https区别

后者会走ssl协议，tcp协议后，加密协议还需要握手，协议（向机构）申请证书

### https的握手

ssl协议基于RSA加密，证书中取公钥，加密发生在sll握手阶段，服务端私钥解密



四次握手

客户端a, 服务器b

1. a -》b 传递a随机数，协议版本/rsa算法
2. b -> a  传递b随机数，确认协议/rsa消息，证书
3. a -> b 取证书中公钥，加密随机数，准备会话密钥通信
4. b -> a 随机数生成会话密钥，准备会话密钥通信

### http1.0/http1.1/http2/http/3

简单/跨平台



长连接-》管道-》请求队头阻塞（响应有顺序）拓展性。



头部压缩（消除重复）/二进制（比较文本）/并发运输（多streamId走一个tcp连接，可以组装，tcp层对头阻塞（少了数据在内核缓冲区等待））/服务器主动推送（都可以建立stream）



基于udp的quic协议：无队头阻塞（单个stream阻塞）/更快（只确认连接id）-》连接迁移（更快）

### http1.1

优点：简单/拓展性/跨平台

缺点：无状态/明文传输/不安全

### tcp什么时候断开

1. close()
2. 超时响应，请求重试超过最大次数
3. 长期未请求or响应

### http/tcp/socket

应用层传输协议，服务端和客户端的通信（格式/规则）



保证可靠的传输层协议，在通信两端建立可靠数据连接



是通信的一端，提供底层通信接口，实现不同计算机之间数据交换



### LocalStorage和cookie

浏览器本地缓存

1. 存储位置
2. 安全性
3. 生命周期
4. 数据发送



### http和Rpc

前者协议，后者（远程接口调用）是一种方式，可以自定义不同的协议，一般对外http，对内rpc



### 长连接和WebSocket

http1.1不支持服务端主动通信（2.0）场景：（网游）



## TCP和UDP区别

连接：有/无

可靠：

传输方式：流式/包

几对几：

流量控制（接收端溢出）/拥塞控制（发送端滑动窗口）：有（影响tcp速率）/无

首部开销：

### tcp的可靠性

握手挥手/序列号/确认应答号/流量控制/拥塞控制（滑动窗口/拥塞窗口 基于重传动态更新+1）/超时重传

### udp实现http

http3.0 -> 无队头阻塞/低延迟/连接迁移

前向纠错，重传/拥塞控制



### tcp沾包

流式传输，找不到边界

固定数据长度/特殊字符作为边界/自定义消息结构（固定长度）处理

## 杂

### MAC地址

网络设备在数据链路层的标识

### 网卡

网络适配器，计算机与网络的必备连接设备，有唯一MAC地址

### 网关

网络关口，协议转换器，解释器，实现两个网络之间互相通信。

### 网桥和交换机

网络设备，连接局域网，根据mac地址转发数据帧。

前者只是端口数，效率不同。

路由器根据IP转发

### DNS

域名系统

#### 域名

www.baidu.com方便人记忆 解析成ip地址

从后往前依次分层为，根服务器，顶级服务器，权威服务器。

无缓存，走dns查ip地址

#### 端口号

53

#### 网络协议

udp：（无连接）低延迟/简单快速/（头部小）轻量

虽然丢包，缓存/查询重传/请求重试

### 报文

是什么：不同OIS层数据传输单元

组成：head+body

应用层 报文

传输层 数据报

网络层 数据包

数据链路层 帧

物理层 二进制比特流

### cookie和session

#### http无状态

是无状态，服务器没有保存客户端的信息，每个请求独立

#### 携带cookie的http，是他的一部分为什么还说无状态

有状态：存储了客户端的状态信息

服务器没存/请求独立

#### 区别

前者存储在客户端，后者存储在服务端

第一次请求后，cookie由服务器创建配置id，发送给客户端。

之后的请求都会携带cookie。

一般用cookie存sessionid在服务器与session比较



都可以设置过期时间，默认关闭浏览器结束生命周期

### WebSocket

tcp连接两端可以同时发送消息。

在http请求中加升级协议head头

### socket

位于应用层和传输层之间的通信接口

### 跨域

协议/域名/端口不同

监测安全性

#### 解决

普通跨域（服务器设置）/携带cookie跨域（前后端都要设置字段）

nginx反向代理



